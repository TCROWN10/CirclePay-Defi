{"version":3,"sources":["../src/server.ts"],"sourcesContent":["// circle-agent/src/server.ts\nimport express from 'express'\nimport cors from 'cors'\nimport { v4 as uuidv4 } from 'uuid'\n\nconst app = express()\nconst PORT = process.env.PORT || 3001\n\n// Middleware\napp.use(cors({\n  origin: process.env.FRONTEND_URL || 'http://localhost:3000',\n  credentials: true\n}))\napp.use(express.json({ limit: '10mb' }))\napp.use(express.urlencoded({ extended: true, limit: '10mb' }))\n\n// Health check endpoint\napp.get('/health', (req, res) => {\n  res.json({ \n    status: 'ok', \n    timestamp: new Date().toISOString(),\n    agent: 'ready',\n    character: 'Circle'\n  })\n})\n\n// Chat endpoint\napp.post('/api/chat', async (req, res) => {\n  try {\n    const { message, conversationId, userId = 'web_user' } = req.body\n\n    if (!message || message.trim().length === 0) {\n      return res.status(400).json({\n        success: false,\n        error: 'Message is required'\n      })\n    }\n\n    const roomId = conversationId || `room_${userId}_${Date.now()}`\n    \n    console.log('Received chat request:', { \n      message: message.trim(), \n      conversationId: roomId, \n      userId \n    })\n\n    // Simple Circle agent response logic\n    let agentResponse = generateCircleResponse(message.trim())\n\n    console.log('Generated response:', { \n      responseLength: agentResponse.length,\n      preview: agentResponse.substring(0, 100) + '...' \n    })\n\n    res.json({\n      success: true,\n      response: agentResponse,\n      conversationId: roomId,\n      timestamp: new Date().toISOString(),\n      messageId: uuidv4()\n    })\n\n  } catch (error) {\n    console.error('Error processing chat message:', error)\n    \n    // Provide a helpful fallback response\n    const fallbackResponse = \"I'm experiencing some technical difficulties right now. As your DeFi assistant, I'm here to help with questions about decentralized finance, yield farming, liquidity provision, and DeFi protocols. Please try your question again!\"\n    \n    res.status(500).json({\n      success: false,\n      error: 'Internal server error',\n      response: fallbackResponse,\n      timestamp: new Date().toISOString()\n    })\n  }\n})\n\n// Get agent info endpoint\napp.get('/api/agent', (req, res) => {\n  res.json({\n    success: true,\n    agent: {\n      name: 'Circle',\n      bio: [\n        \"Expert in decentralized finance (DeFi) protocols and strategies\",\n        \"Helps users navigate the complex world of DeFi safely\",\n        \"Provides insights on yield farming, liquidity provision, and token swaps\",\n        \"Emphasizes risk management and user education\",\n        \"Stays updated on the latest DeFi trends and opportunities\"\n      ],\n      topics: [\n        \"DeFi protocols\",\n        \"yield farming\",\n        \"liquidity provision\",\n        \"decentralized exchanges\",\n        \"smart contracts\",\n        \"blockchain networks\",\n        \"risk management\",\n        \"token economics\",\n        \"circlepay bridges\",\n        \"DeFi analytics\"\n      ],\n      modelProvider: \"openai\",\n      model: \"gpt-4\"\n    }\n  })\n})\n\n// Simple Circle agent response generation\nfunction generateCircleResponse(userMessage: string): string {\n  const message = userMessage.toLowerCase()\n  \n  // Basic response patterns for Circle\n  if (message.includes('hello') || message.includes('hi') || message.includes('hey')) {\n    return \"Hello! I'm Circle, your DeFi assistant. I'm here to help you navigate the world of decentralized finance safely. What would you like to learn about today? 🚀\"\n  }\n  \n  if (message.includes('yield') || message.includes('farming')) {\n    return \"Great question about yield farming! Yield farming involves providing liquidity to DeFi protocols to earn rewards. Here are some key points:\\n\\n\" +\n           \"• **Liquidity Provision**: Add tokens to DEX pools (like ETH/USDC on Uniswap)\\n\" +\n           \"• **Lending**: Deposit assets on platforms like Aave to earn interest\\n\" +\n           \"• **Staking**: Lock tokens to support network operations\\n\\n\" +\n           \"⚠️ **Important Risks**: Impermanent loss, smart contract vulnerabilities, market volatility\\n\\n\" +\n           \"Would you like me to explain any specific yield farming strategy in detail?\"\n  }\n  \n  if (message.includes('defi') || message.includes('decentralized')) {\n    return \"DeFi (Decentralized Finance) is a revolutionary financial system built on blockchain technology! Here's what makes it special:\\n\\n\" +\n           \"• **No Intermediaries**: Direct peer-to-peer transactions\\n\" +\n           \"• **Global Access**: Available to anyone with an internet connection\\n\" +\n           \"• **Transparency**: All transactions are visible on the blockchain\\n\" +\n           \"• **Composability**: Protocols can work together like building blocks\\n\\n\" +\n           \"What specific aspect of DeFi interests you most?\"\n  }\n  \n  if (message.includes('risk') || message.includes('safe')) {\n    return \"Excellent question about DeFi safety! Here are the key risk factors to consider:\\n\\n\" +\n           \"🛡️ **Smart Contract Risk**: Always check if protocols are audited\\n\" +\n           \"💰 **Impermanent Loss**: Can occur in liquidity pools\\n\" +\n           \"📊 **Market Volatility**: Crypto prices can be highly volatile\\n\" +\n           \"🔒 **Private Key Security**: Never share your seed phrase\\n\\n\" +\n           \"My advice: Start small, use well-established protocols, and always DYOR (Do Your Own Research)!\"\n  }\n  \n  if (message.includes('start') || message.includes('begin')) {\n    return \"Perfect! Here's how to start your DeFi journey safely:\\n\\n\" +\n           \"1. **Education First**: Learn about wallets, smart contracts, and how DeFi works\\n\" +\n           \"2. **Start Small**: Begin with amounts you can afford to lose\\n\" +\n           \"3. **Use Established Protocols**: Stick to well-audited protocols like Uniswap, Aave, or Compound\\n\" +\n           \"4. **Understand Gas Fees**: Factor in transaction costs\\n\" +\n           \"5. **Security First**: Use hardware wallets when possible\\n\\n\" +\n           \"What's your first DeFi goal? I can help guide you!\"\n  }\n  \n  // Default response\n  return `Thanks for your message: \"${userMessage}\"! I'm Circle, your DeFi assistant, and I'm here to help you understand decentralized finance, yield farming strategies, risk management, and much more. What specific DeFi topic would you like to explore? 💡`\n}\n\n// Error handling middleware\napp.use((error: any, req: express.Request, res: express.Response, next: express.NextFunction) => {\n  console.error('Unhandled error:', error)\n  res.status(500).json({\n    success: false,\n    error: 'Internal server error',\n    timestamp: new Date().toISOString()\n  })\n})\n\n// Start the server\napp.listen(PORT, () => {\n  console.log(`=================================`)\n  console.log(`🤖 Circle DeFi Agent Server Started`)\n  console.log(`=================================`)\n  console.log(`Port: ${PORT}`)\n  console.log(`Health check: http://localhost:${PORT}/health`)\n  console.log(`Chat endpoint: http://localhost:${PORT}/api/chat`)\n  console.log(`Agent info: http://localhost:${PORT}/api/agent`)\n  console.log(`Agent: Circle`)\n  console.log(`=================================`)\n})\n\n// Handle graceful shutdown\nconst gracefulShutdown = async (signal: string) => {\n  console.log(`Received ${signal}. Shutting down gracefully...`)\n  process.exit(0)\n}\n\nprocess.on('SIGINT', gracefulShutdown)\nprocess.on('SIGTERM', gracefulShutdown)\n\n// Handle uncaught exceptions\nprocess.on('uncaughtException', (error) => {\n  console.error('Uncaught Exception:', error)\n  process.exit(1)\n})\n\nprocess.on('unhandledRejection', (reason, promise) => {\n  console.error('Unhandled Rejection at:', promise, 'reason:', reason)\n  process.exit(1)\n})"],"mappings":"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","names":[]}